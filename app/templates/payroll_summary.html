<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'head.html' %}
    <title>Payroll Summary</title>
</head>
<style>
    .download-link {
        text-decoration: none;
        color: #007bff;
        font-weight: 500
    }

    .download-link:hover {
        text-decoration: underline;
    }
</style>
<body>
{% include 'navbar.html' %}
{% include 'flash_message.html' %}

<section class="container mt-4">
    <form action="{{ url_for('payroll_summary') }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row g-3 align-items-end">

            <!-- Year Selector -->
            <div class="col-md-3">
                <label for="year" class="form-label">Select Year</label>
                <select id="year" name="year" class="form-control">
                    <option value="">-- Select Year --</option>
                    {% for y in range(2023, 2026) %}
                        <option value="{{ y }}">{{ y }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Week Selector (Shows Week Number + Dates) -->
            <div class="col-md-4">
                <label for="week" class="form-label">Select Week</label>
                <select id="week" name="week" class="form-control">
                    <option value="">-- Select Week --</option>
                </select>
            </div>

            <!-- View Summary Button -->
            <div class="col-md-2">
                <button class="btn btn-dark w-100" id="">
                    <i class="bi bi-funnel"></i> View Summary
                </button>
            </div>

            <!-- Download Button -->
            <div class="col-md-2">
                <a href="" type="button" class="btn btn-success w-100" id="downloadBtn">Download</a>
            </div>
        </div>
    </form>

    <!-- Section for summary results -->
    <div id="summaryResults" class="mt-4"></div>
</section>
{% if data %}
    <section>
        <div class="container">
            <table class="table table-hover">
                <!-- Header section -->
                <tr>
                    <th>1</th>
                    <th>Period</th>
                    <th>Date</th>
                    <th>Account Code</th>
                    <th>Reference</th>
                    <th>Description</th>
                    <th>Base Amount</th>
                    <th>Dr/Cr</th>
                    <th>Property</th>
                    <th>Outlet</th>
                    <th>Sub Outlet</th>
                    <th>Journal Type</th>
                </tr>
                <!-- Summation Section for basic salary -->
                {% if data.crosses_month %}
                    <!-- This displays if requested data crosses 2 months -->
                    <tr>
                        <td>{{ data.first_range[0][0] }}</td>
                        <td>{{ data.first_range[0][1] }}</td>
                        <td>{{ data.first_range[0][2] }}</td>
                        <td>110383</td>
                        <td>{{ data.sum_of_first_range[0] }}</td>
                        <td>M-pesa Payments</td>
                        <td>{{ '{:,}'.format(data.sum_of_first_range[1]) }}</td>
                        <td>C</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>MPESA</td>
                    </tr>
                    <tr>
                        <td>{{ data.second_range[0][0] }}</td>
                        <td>{{ data.second_range[0][1] }}</td>
                        <td>{{ data.second_range[0][2] }}</td>
                        <td>110383</td>
                        <td>{{ data.last_day_formated }}</td>
                        <td>M-pesa Payments</td>
                        <td>{{ '{:,}'.format(data.sum_of_second_range) }}</td>
                        <td>C</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>MPESA</td>
                    </tr>
                {% else %}
                    <!-- This displays if requested data is all within the same month -->
                    <tr>
                        <td>{{ data.all_range[0][0] }}</td>
                        <td>{{ data.all_range[0][1] }}</td>
                        <td>{{ data.all_range[0][2] }}</td>
                        <td>110383</td>
                        <td>{{ data.last_day_formated }}</td>
                        <td>M-pesa Payments</td>
                        <td>{{ '{:,}'.format(data.sum_of_all_ranges) }}</td>
                        <td>C</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>MPESA</td>
                    </tr>
                {% endif %}
                <!-- End of summation Section for basic salary -->
                <!-- for loop to display the aggregated section of deductions (advances, housing levy, NSSF,
                PAYE, Pending bills, SHIF, tips) -->
                {% for key, values in aggregated_data.items() %}
                    <tr>
                        <td>{{ values[0] }}</td>
                        <td>{{ values[1] }}</td>
                        <td>{{ values[2] }}</td>
                        <td>110383</td>
                        <td>{{ data.last_day_formated }}</td>
                        <td>{{ key }}</td>
                        <td>{{ '{:,}'.format(values[3]) }}</td>
                        <td>D</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>MPESA</td>
                    </tr>
                {% endfor %}
                <!-- Detailed data Section for basic salary -->
                {% if data.crosses_month %}
                    {% for row in data.first_range %}
                        <tr>
                            <td>{{ row[0] }}</td>
                            <td>{{ row[1] }}</td>
                            <td>{{ row[2] }}</td>
                            <td>{{ row[3] }}</td>
                            <td>{{ row[4] }}</td>
                            <td>{{ row[5] }}</td>
                            <td>{{ '{:,}'.format(row[6]) }}</td>
                            <td>{{ row[7] }}</td>
                            <td>{{ row[8] }}</td>
                            <td>{{ row[9] }}</td>
                            <td>{{ row[10] }}</td>
                            <td>MPESA</td>
                        </tr>
                    {% endfor %}
                    {% for row in data.second_range %}
                        <tr>
                            <td>{{ row[0] }}</td>
                            <td>{{ row[1] }}</td>
                            <td>{{ row[2] }}</td>
                            <td>{{ row[3] }}</td>
                            <td>{{ row[4] }}</td>
                            <td>{{ row[5] }}</td>
                            <td>{{ '{:,}'.format(row[6]) }}</td>
                            <td>{{ row[7] }}</td>
                            <td>{{ row[8] }}</td>
                            <td>{{ row[9] }}</td>
                            <td>{{ row[10] }}</td>
                            <td>MPESA</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    {% for row in data.all_range %}
                        <tr>
                            <td>{{ row[0] }}</td>
                            <td>{{ row[1] }}</td>
                            <td>{{ row[2] }}</td>
                            <td>{{ row[3] }}</td>
                            <td>{{ row[4] }}</td>
                            <td>{{ row[5] }}</td>
                            <td>{{ '{:,}'.format(row[6]) }}</td>
                            <td>{{ row[7] }}</td>
                            <td>{{ row[8] }}</td>
                            <td>{{ row[9] }}</td>
                            <td>{{ row[10] }}</td>
                            <td>MPESA</td>
                        </tr>
                    {% endfor %}
                {% endif %}
                <!-- End of Detailed data Section for basic salary -->
                <!-- for loop to display the detailed section of deductions -->
                {% for key, values in deductions_data.items() %}
                    <th>{{ key }}</th>
                    {% for row in values %}
                        <tr>
                            {% for item in row %}
                                <td>{{ item }}</td>
                            {% endfor %}
                            <td>MPESA</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </table>
        </div>
    </section>
{% endif %}

<script>
    // Helper: Generate Sundayâ€“Saturday weeks for a given year
    function generateWeeks(year) {
        const weeks = [];
        let startDate = new Date(year, 0, 1);

        // Move to first Sunday of the year
        while (startDate.getDay() !== 0) {
            startDate.setDate(startDate.getDate() + 1);
        }

        let weekNum = 1;
        while (startDate.getFullYear() === year ||
        (startDate.getFullYear() === year + 1 && startDate.getMonth() === 0)) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            weeks.push({
                week: weekNum,
                start: new Date(startDate),
                end: new Date(endDate)
            });

            startDate.setDate(startDate.getDate() + 7);
            weekNum++;

            // Stop once we've passed into the next year (beyond week 52/53)
            if (startDate.getFullYear() > year && startDate.getMonth() > 0) break;
        }

        return weeks;
    }

    // Helper: Format date like "30 Jun 2025"
    function formatDate(date) {
        return date.toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'});
    }

    // Populate weeks when year is selected
    document.getElementById("year").addEventListener("change", function () {
        const year = this.value;
        const weekSelect = document.getElementById("week");
        weekSelect.innerHTML = '<option value="">-- Select Week --</option>';
        if (!year) return;

        const weeks = generateWeeks(parseInt(year));
        weeks.forEach(w => {
            const option = document.createElement("option");
            option.value = w.week;
            option.textContent = `Week ${w.week} (${formatDate(w.start)} - ${formatDate(w.end)})`;
            weekSelect.appendChild(option);
        });
    });
    // Download Button Action
    document.getElementById("downloadBtn").addEventListener("click", function () {
        const year = document.getElementById("year").value;
        const week = document.getElementById("week").value;
        if (!year || !week) {
            alert("Please select both year and week before downloading.");
            return;
        }
        window.open(`{{ url_for('generate_excel') }}?year=${year}&week=${week}`, '_blank');
    });
</script>

</body>
</html>


